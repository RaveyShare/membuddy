# 用户中心配置说明

## 概述

本文档详细说明了如何配置和使用新的用户中心认证系统。新系统支持独立的用户中心服务，不再依赖项目内部的后端认证。

## 配置文件说明

### 1. 环境配置 (`mina/utils/dev-config.js`)

#### 环境切换
```javascript
// 开发环境配置
const DEV_CONFIG = {
  useMock: true,           // 是否使用 Mock 数据
  useUserCenter: true,     // 是否使用用户中心
  userCenterBaseUrl: 'https://user-center.example.com/api'
}

// 生产环境配置
const PROD_CONFIG = {
  useMock: false,
  useUserCenter: true,
  userCenterBaseUrl: 'https://user-center-prod.example.com/api'
}
```

#### 用户中心接口配置
```javascript
userCenter: {
  wechatLogin: '/auth/wechat/mini',      // 微信小程序登录
  refreshToken: '/auth/refresh',          // 刷新 Token
  logout: '/auth/logout',                 // 登出
  userInfo: '/user/info'                  // 获取用户信息
}
```

### 2. API 客户端 (`mina/utils/api.js`)

#### 用户中心 API 调用
```javascript
// 微信登录
const loginResult = await api.userCenter.wechatLogin({
  code: 'wx_login_code',
  userInfo: {
    nickname: '用户昵称',
    avatarUrl: '头像URL'
  }
});

// 刷新 Token
const refreshResult = await api.userCenter.refreshToken();

// 获取用户信息
const userInfo = await api.userCenter.userInfo();

// 登出
await api.userCenter.logout();
```

### 3. 认证管理 (`mina/utils/auth.js`)

#### 新增的认证数据字段
- `accessToken`: 用户中心访问令牌
- `tokenType`: 令牌类型（通常为 'Bearer'）
- `expiresIn`: 令牌过期时间（秒）

#### 主要方法
```javascript
// 用户中心登录
await userCenterLogin(code, userInfo);

// 刷新用户中心 Token
await refreshUserCenterToken();

// 获取访问令牌
const token = getAccessToken();

// 获取令牌类型
const tokenType = getTokenType();
```

## 接口格式说明

### 1. 微信登录接口

**请求格式：**
```bash
curl -X POST "https://user-center.example.com/api/auth/wechat/mini" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "微信登录code",
    "userInfo": {
      "nickname": "用户昵称",
      "avatarUrl": "头像URL"
    }
  }'
```

**响应格式：**
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 7200,
    "refreshToken": "refresh_token_string",
    "user": {
      "id": "user_id",
      "nickname": "用户昵称",
      "avatarUrl": "头像URL",
      "openid": "wx_openid"
    }
  }
}
```

### 2. 刷新 Token 接口

**请求格式：**
```bash
curl -X POST "https://user-center.example.com/api/auth/refresh" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer refresh_token" \
  -d '{}'
```

**响应格式：**
```json
{
  "success": true,
  "data": {
    "accessToken": "new_access_token",
    "tokenType": "Bearer",
    "expiresIn": 7200
  }
}
```

### 3. 获取用户信息接口

**请求格式：**
```bash
curl -X GET "https://user-center.example.com/api/user/info" \
  -H "Authorization: Bearer access_token"
```

**响应格式：**
```json
{
  "success": true,
  "data": {
    "id": "user_id",
    "nickname": "用户昵称",
    "avatarUrl": "头像URL",
    "openid": "wx_openid",
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-01T00:00:00Z"
  }
}
```

### 4. 登出接口

**请求格式：**
```bash
curl -X POST "https://user-center.example.com/api/auth/logout" \
  -H "Authorization: Bearer access_token" \
  -d '{}'
```

**响应格式：**
```json
{
  "success": true,
  "message": "登出成功"
}
```

## 使用指南

### 1. 开发环境配置

1. **启用 Mock 模式**（推荐用于本地开发）：
   ```javascript
   // 在 dev-config.js 中设置
   const config = {
     useMock: true,
     useUserCenter: true
   };
   ```

2. **使用真实接口**：
   ```javascript
   const config = {
     useMock: false,
     useUserCenter: true,
     userCenterBaseUrl: 'https://your-user-center.com/api'
   };
   ```

### 2. 生产环境配置

```javascript
const PROD_CONFIG = {
  useMock: false,
  useUserCenter: true,
  userCenterBaseUrl: 'https://prod-user-center.com/api'
};
```

### 3. 登录页面使用

```javascript
// 在登录页面中
import { userCenterLogin } from '../../utils/auth.js';

// 微信登录
async onWechatLogin(userInfo) {
  try {
    const result = await userCenterLogin(code, userInfo);
    if (result.success) {
      // 登录成功，跳转到主页
      wx.switchTab({ url: '/pages/index/index' });
    }
  } catch (error) {
    console.error('登录失败:', error);
    wx.showToast({
      title: '登录失败，请重试',
      icon: 'none'
    });
  }
}
```

## 测试功能

### 1. 配置测试

运行配置测试以验证环境配置：
```javascript
// 在小程序控制台中执行
wx.testConfig.runAllTests();
```

### 2. 登录功能测试

测试完整的登录流程：
```javascript
// 在小程序控制台中执行
wx.testLogin.testCompleteLoginFlow();
```

### 3. Mock 数据测试

测试 Mock 模式下的登录：
```javascript
wx.testLogin.testMockLogin();
```

## 兼容性说明

### 1. 向后兼容

系统保持对旧版本认证的兼容性：
- 旧的 `token` 和 `refreshToken` 仍然支持
- 新的 `accessToken`、`tokenType`、`expiresIn` 优先使用
- 认证检查会自动选择可用的令牌

### 2. 迁移策略

从旧版本迁移到新版本：
1. 用户重新登录时自动使用新的用户中心
2. 旧的认证数据会在新登录时被清除
3. 无需手动迁移用户数据

## 错误处理

### 1. 网络错误

```javascript
{
  "success": false,
  "error": "NETWORK_ERROR",
  "message": "网络连接失败"
}
```

### 2. 认证错误

```javascript
{
  "success": false,
  "error": "AUTH_FAILED",
  "message": "认证失败，请重新登录"
}
```

### 3. Token 过期

```javascript
{
  "success": false,
  "error": "TOKEN_EXPIRED",
  "message": "登录已过期，请重新登录"
}
```

## 安全注意事项

1. **Token 存储**：
   - `accessToken` 存储在小程序本地存储中
   - `refreshToken` 用于刷新访问令牌
   - 定期检查 Token 过期状态

2. **HTTPS 要求**：
   - 生产环境必须使用 HTTPS
   - 开发环境可以使用 HTTP（仅限本地）

3. **错误日志**：
   - 不在日志中记录敏感信息
   - 错误信息对用户友好

## 常见问题

### Q: 如何切换到用户中心模式？
A: 在 `dev-config.js` 中设置 `useUserCenter: true`。

### Q: Mock 数据如何自定义？
A: 修改 `dev-config.js` 中的 `MOCK_DATA` 对象。

### Q: 如何调试登录问题？
A: 使用测试文件中的测试函数，在控制台查看详细日志。

### Q: 生产环境如何配置？
A: 修改 `PROD_CONFIG` 中的 `userCenterBaseUrl` 为实际的用户中心地址。

## 更新日志

- **v1.0.0**: 初始版本，支持用户中心认证
- 新增用户中心接口配置
- 新增 Mock 数据支持
- 新增完整的测试套件
- 保持向后兼容性