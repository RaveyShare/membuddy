<!--pages/memory-item/memory-item.wxml-->
<view class="memory-item-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-title"></view>
      <view class="loading-text"></view>
      <view class="loading-text"></view>
      <view class="loading-meta"></view>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-container" wx:if="{{!loading && memory}}">
    <!-- å¤´éƒ¨æ“ä½œæ  -->
    <view class="header-actions">
      <view class="action-group">
        <view class="action-btn" bindtap="onToggleEditMode">
          <text class="icon">{{mode === 'edit' ? 'ğŸ‘ï¸' : 'âœï¸'}}</text>
          <text class="action-text">{{mode === 'edit' ? 'æŸ¥çœ‹' : 'ç¼–è¾‘'}}</text>
        </view>
        
        <view class="action-btn" bindtap="onShareMemory">
          <text class="icon">ğŸ“¤</text>
          <text class="action-text">åˆ†äº«</text>
        </view>
        
        <view class="action-btn danger" bindtap="onDeleteMemory">
          <text class="icon">ğŸ—‘ï¸</text>
          <text class="action-text">åˆ é™¤</text>
        </view>
      </view>
    </view>

    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <view class="view-mode" wx:if="{{mode === 'view'}}">
      <!-- è®°å¿†é¡¹ä¿¡æ¯ -->
      <view class="memory-card">
        <view class="memory-header">
          <text class="memory-title">{{memory.title}}</text>
          <view class="memory-meta">
            <text class="meta-item">{{memory.category || 'æœªåˆ†ç±»'}}</text>
            <text class="meta-separator">â€¢</text>
            <text class="meta-item">{{memory.created_at_formatted}}</text>
          </view>
        </view>
        
        <view class="memory-content">
          <text class="content-text">{{memory.content}}</text>
        </view>
        
        <view class="memory-tags" wx:if="{{memory.tags && memory.tags.length > 0}}">
          <text 
            class="tag"
            wx:for="{{memory.tags}}"
            wx:for-item="tag"
            wx:key="*this"
          >
            #{{tag}}
          </text>
        </view>
        
        <view class="memory-footer">
          <text class="update-time">æœ€åæ›´æ–°ï¼š{{memory.updated_at_formatted}}</text>
          <view class="copy-btn" data-content="{{memory.content}}" bindtap="onCopyContent">
            <text class="icon">ğŸ“‹</text>
            <text class="copy-text">å¤åˆ¶å†…å®¹</text>
          </view>
        </view>
      </view>

      <!-- è®°å¿†è¾…åŠ©å·¥å…· -->
      <view class="memory-aids-section">
        <view class="section-header">
          <text class="section-title">è®°å¿†è¾…åŠ©å·¥å…·</text>
          <view class="generate-btn" bindtap="onGenerateMemoryAids" wx:if="{{!memoryAids}}">
            <text class="btn-text">{{generating ? 'ç”Ÿæˆä¸­...' : 'AIç”Ÿæˆ'}}</text>
          </view>
        </view>
        
        <!-- æ— è®°å¿†è¾…åŠ©çŠ¶æ€ -->
        <view class="no-aids" wx:if="{{!memoryAids && !generating}}">
          <view class="no-aids-icon">ğŸ§ </view>
          <text class="no-aids-title">æš‚æ— è®°å¿†è¾…åŠ©å·¥å…·</text>
          <text class="no-aids-desc">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼Œè®©AIä¸ºä½ ç”Ÿæˆä¸“å±çš„è®°å¿†è¾…åŠ©å·¥å…·</text>
        </view>
        
        <!-- ç”Ÿæˆä¸­çŠ¶æ€ -->
        <view class="generating-state" wx:if="{{generating}}">
          <view class="generating-icon">ğŸ¤–</view>
          <text class="generating-text">AIæ­£åœ¨ä¸ºä½ ç”Ÿæˆè®°å¿†è¾…åŠ©å·¥å…·...</text>
        </view>
        
        <!-- è®°å¿†è¾…åŠ©å†…å®¹ -->
        <view class="aids-content" wx:if="{{memoryAids && !generating}}">
          <!-- æ€ç»´å¯¼å›¾ -->
          <view class="aid-section" wx:if="{{memoryAids.mind_map}}">
            <view class="aid-header" data-section="mindMap" bindtap="onToggleSection">
              <text class="aid-title">ğŸ—ºï¸ æ€ç»´å¯¼å›¾</text>
              <text class="toggle-icon">{{expandedSections.mindMap ? 'â–¼' : 'â–¶'}}</text>
            </view>
            <view class="aid-content" wx:if="{{expandedSections.mindMap}}">
              <view class="mind-map">
                <view class="central-node">{{memoryAids.mind_map.central_topic}}</view>
                <view class="branches">
                  <view 
                    class="branch"
                    wx:for="{{memoryAids.mind_map.branches}}"
                    wx:key="topic"
                  >
                    <text class="branch-topic">{{item.topic}}</text>
                    <view class="sub-branches" wx:if="{{item.subtopics && item.subtopics.length > 0}}">
                      <text 
                        class="sub-branch"
                        wx:for="{{item.subtopics}}"
                        wx:for-item="subtopic"
                        wx:key="*this"
                      >
                        {{subtopic}}
                      </text>
                    </view>
                  </view>
                </view>
              </view>
              <view class="copy-btn" data-content="{{memoryAids.mind_map}}" bindtap="onCopyContent">
                <text class="icon">ğŸ“‹</text>
                <text class="copy-text">å¤åˆ¶</text>
              </view>
            </view>
          </view>
          
          <!-- å…³é”®åŸç† -->
          <view class="aid-section" wx:if="{{memoryAids.key_principles && memoryAids.key_principles.length > 0}}">
            <view class="aid-header" data-section="keyPrinciples" bindtap="onToggleSection">
              <text class="aid-title">ğŸ”‘ å…³é”®åŸç†</text>
              <text class="toggle-icon">{{expandedSections.keyPrinciples ? 'â–¼' : 'â–¶'}}</text>
            </view>
            <view class="aid-content" wx:if="{{expandedSections.keyPrinciples}}">
              <view 
                class="principle-item"
                wx:for="{{memoryAids.key_principles}}"
                wx:key="principle"
              >
                <text class="principle-title">{{item.principle}}</text>
                <text class="principle-explanation">{{item.explanation}}</text>
                <text class="principle-example" wx:if="{{item.example}}">ç¤ºä¾‹ï¼š{{item.example}}</text>
              </view>
            </view>
          </view>
          
          <!-- è®°å¿†åœºæ™¯ -->
          <view class="aid-section" wx:if="{{memoryAids.memory_scenes && memoryAids.memory_scenes.length > 0}}">
            <view class="aid-header" data-section="memoryScenes" bindtap="onToggleSection">
              <text class="aid-title">ğŸ¬ è®°å¿†åœºæ™¯</text>
              <text class="toggle-icon">{{expandedSections.memoryScenes ? 'â–¼' : 'â–¶'}}</text>
            </view>
            <view class="aid-content" wx:if="{{expandedSections.memoryScenes}}">
              <view 
                class="scene-item"
                wx:for="{{memoryAids.memory_scenes}}"
                wx:key="scene_description"
              >
                <text class="scene-title">åœºæ™¯ {{index + 1}}</text>
                <text class="scene-description">{{item.scene_description}}</text>
                <text class="scene-connection">å…³è”ï¼š{{item.connection_to_content}}</text>
              </view>
            </view>
          </view>
          
          <!-- è®°å¿†æ³• -->
          <view class="aid-section" wx:if="{{memoryAids.mnemonics && memoryAids.mnemonics.length > 0}}">
            <view class="aid-header" data-section="mnemonics" bindtap="onToggleSection">
              <text class="aid-title">ğŸ¯ è®°å¿†æ³•</text>
              <text class="toggle-icon">{{expandedSections.mnemonics ? 'â–¼' : 'â–¶'}}</text>
            </view>
            <view class="aid-content" wx:if="{{expandedSections.mnemonics}}">
              <view 
                class="mnemonic-item"
                wx:for="{{memoryAids.mnemonics}}"
                wx:key="technique"
              >
                <text class="mnemonic-technique">{{item.technique}}</text>
                <text class="mnemonic-application">{{item.application}}</text>
              </view>
            </view>
          </view>
          
          <!-- æ„Ÿå®˜è”æƒ³ -->
          <view class="aid-section" wx:if="{{memoryAids.sensory_associations && memoryAids.sensory_associations.length > 0}}">
            <view class="aid-header" data-section="sensoryAssociations" bindtap="onToggleSection">
              <text class="aid-title">ğŸ‘ï¸ æ„Ÿå®˜è”æƒ³</text>
              <text class="toggle-icon">{{expandedSections.sensoryAssociations ? 'â–¼' : 'â–¶'}}</text>
            </view>
            <view class="aid-content" wx:if="{{expandedSections.sensoryAssociations}}">
              <view 
                class="sensory-item"
                wx:for="{{memoryAids.sensory_associations}}"
                wx:key="sensory_type"
              >
                <text class="sensory-type">{{item.sensory_type}}</text>
                <text class="sensory-description">{{item.description}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <view class="edit-mode" wx:if="{{mode === 'edit'}}">
      <view class="edit-form">
        <!-- æ ‡é¢˜ç¼–è¾‘ -->
        <view class="form-group">
          <text class="form-label">æ ‡é¢˜</text>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥è®°å¿†æ ‡é¢˜"
            value="{{editForm.title}}"
            bindinput="onTitleInput"
            maxlength="100"
          />
        </view>
        
        <!-- å†…å®¹ç¼–è¾‘ -->
        <view class="form-group">
          <text class="form-label">å†…å®¹</text>
          <textarea 
            class="form-textarea"
            placeholder="è¯·è¾“å…¥è®°å¿†å†…å®¹"
            value="{{editForm.content}}"
            bindinput="onContentInput"
            maxlength="2000"
            auto-height
          />
        </view>
        
        <!-- åˆ†ç±»é€‰æ‹© -->
        <view class="form-group">
          <text class="form-label">åˆ†ç±»</text>
          <picker 
            class="form-picker"
            range="{{categories}}"
            range-key="label"
            value="{{editForm.category}}"
            bindchange="onCategoryChange"
          >
            <view class="picker-content">
              <text class="picker-text">{{selectedCategoryLabel}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <!-- æ ‡ç­¾ç¼–è¾‘ -->
        <view class="form-group">
          <view class="form-label-row">
            <text class="form-label">æ ‡ç­¾</text>
            <view class="add-tag-btn" bindtap="onAddTag">
              <text class="add-icon">+</text>
              <text class="add-text">æ·»åŠ æ ‡ç­¾</text>
            </view>
          </view>
          <view class="tags-container" wx:if="{{editForm.tags.length > 0}}">
            <view 
              class="tag-item"
              wx:for="{{editForm.tags}}"
              wx:key="*this"
              data-index="{{index}}"
              bindtap="onRemoveTag"
            >
              <text class="tag-text">#{{item}}</text>
              <text class="remove-icon">Ã—</text>
            </view>
          </view>
        </view>
        
        <!-- ä¿å­˜æŒ‰é’® -->
        <view class="form-actions">
          <button 
            class="btn btn-primary save-btn"
            bindtap="onSaveEdit"
            disabled="{{saving}}"
            loading="{{saving}}"
          >
            {{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ä¿®æ”¹'}}
          </button>
        </view>
      </view>
    </view>
  </view>
</view>